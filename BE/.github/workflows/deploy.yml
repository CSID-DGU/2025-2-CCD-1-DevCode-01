name: Deploy BE to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to EC2 with SSH
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "ğŸ“Œ BE ë°°í¬ ì‹œì‘"

          cd /home/ubuntu/2025-2-CCD-1-DevCode-01/BE

          echo "ğŸ“Œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          git pull origin main

          echo "ğŸ“Œ ê°€ìƒí™˜ê²½ í™œì„±í™”..."
          source venv/bin/activate

          echo "ğŸ“Œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸..."
          pip install -r requirements.txt

          echo "ğŸ“Œ Django migrate ì‹¤í–‰..."
          python manage.py migrate --noinput

          echo "ğŸ“Œ Daphne ì¬ì‹œì‘..."
          sudo systemctl daemon-reload
          sudo systemctl restart daphne

          echo "ğŸ“Œ Nginx ì¬ì‹œì‘..."
          sudo systemctl restart nginx

          echo "âœ… BE ë°°í¬ ì™„ë£Œ!"
